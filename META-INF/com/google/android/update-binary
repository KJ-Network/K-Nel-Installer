#!/sbin/sh

#################
# Initialization
#################

BOOTMODE=false;
ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;

umask 022

# Global vars
TMPDIR=/tmp/ski

rm -rf $TMPDIR 2>/dev/null
mkdir -p $TMPDIR
MODPATH=$TMPDIR

##############
# Environment
##############

OUTFD=$2
ZIPFILE=$3

ui_print() {
  if $BOOTMODE; then
    echo "$1"
  else
    echo -e "ui_print $1\nui_print" >> /proc/self/fd/$OUTFD
  fi
}

abort() {
  ui_print "$1"
  rm -rf $TMPDIR
  exit 1
}

# Extract files
unzip "$ZIPFILE" -d $TMPDIR >&2

# Load utility functions
. $TMPDIR/tools/env_prepare.sh

##########
# Install
##########

# setup permissions
chmod +x $MODPATH/customize.sh

# Load customization script
. $MODPATH/customize.sh

##############
# Finalizing
##############

cd /
rm -rf $TMPDIR

exit 0