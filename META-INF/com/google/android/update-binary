#!/sbin/sh

#################
# Initialization
#################

BOOTMODE=false;
ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;

KERNELFLASHER=false
if [ -n "$(ps -ef | grep '[b]usybox ash')" ]; then
    KERNELFLASHER=true
fi

umask 022

# Global vars
if $BOOTMODE; then
    TMPDIR=/data/local/tmp/ski
else
    TMPDIR=/tmp/ski
fi

rm -rf $TMPDIR 2>/dev/null
mkdir -p $TMPDIR
MODPATH=$TMPDIR

##############
# Environment
##############

OUTFD=$2
ZIPFILE=$3

ui_print() {
    if $BOOTMODE && [ $KERNELFLASHER == "false" ]; then
        echo "$1"
    else
        until [ ! "$1" ]; do
            echo "ui_print $1
                ui_print" >> /proc/self/fd/$OUTFD;
            shift;
        done;
    fi
}

abort() {
  ui_print "$1"
  rm -rf $TMPDIR
  exit 1
}

# Extract files
unzip "$ZIPFILE" -d $TMPDIR >&2

# Load utility functions
. $TMPDIR/tools/env_prepare.sh

##########
# Install
##########

# setup permissions
chmod +x $MODPATH/customize.sh

# Load customization script
. $MODPATH/customize.sh

##############
# Finalizing
##############

cd /
rm -rf $TMPDIR

exit 0